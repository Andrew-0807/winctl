<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WinCTL</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%231a1e28'/%3E%3Cstop offset='100%25' style='stop-color:%230d0f14'/%3E%3C/linearGradient%3E%3ClinearGradient id='accent' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%237b8ff5'/%3E%3Cstop offset='100%25' style='stop-color:%235e72e4'/%3E%3C/linearGradient%3E%3ClinearGradient id='green' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%232eea8a'/%3E%3Cstop offset='100%25' style='stop-color:%2322d47a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='96' fill='url(%23bg)'/%3E%3Ccircle cx='256' cy='256' r='220' fill='none' stroke='%23252a38' stroke-width='8'/%3E%3Ccircle cx='256' cy='256' r='180' fill='none' stroke='%231e2334' stroke-width='6'/%3E%3Ccircle cx='256' cy='248' r='130' fill='none' stroke='%23252a38' stroke-width='20'/%3E%3Cpath d='M 256 118 A 130 130 0 1 1 256 378' fill='none' stroke='url(%23accent)' stroke-width='14' stroke-linecap='round'/%3E%3Crect x='236' y='178' width='40' height='110' rx='20' fill='url(%23accent)'/%3E%3Ccircle cx='400' cy='140' r='22' fill='%230d0f14' stroke='%231a1e28' stroke-width='4'/%3E%3Ccircle cx='400' cy='140' r='16' fill='url(%23green)'/%3E%3C/svg%3E" type="image/svg+xml">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=0xProto:wght@400;500;600&display=swap" rel="stylesheet">
<script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<style>
  :root {
    --bg: #0d0f14;
    --surface: #13161d;
    --surface2: #1a1e28;
    --border: #252a38;
    --border2: #2e3547;
    --text: #e8ecf5;
    --text2: #8892a8;
    --text3: #505870;
    --green: #22d47a;
    --green-dim: #1a4a32;
    --red: #f5524a;
    --red-dim: #3d1f1d;
    --yellow: #f0b429;
    --yellow-dim: #3d2f10;
    --blue: #4d9de0;
    --blue-dim: #1a2d47;
    --accent: #5e72e4;
    --accent-glow: rgba(94,114,228,0.3);
    --font-mono: '0xProto', monospace;
    --font-sans: '0xProto', sans-serif;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html { font-size: 16px; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-sans);
    min-height: 100vh;
    line-height: 1.5;
  }

  /* ── Layout ── */
  .shell {
    display: grid;
    grid-template-rows: 56px 1fr;
    --sidebar-width: 240px;
    grid-template-columns: var(--sidebar-width) 1fr;
    transition: grid-template-columns 0.2s ease;
  }

  /* ── Header ── */
  header {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    padding: 0 20px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    gap: 16px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    font-family: var(--font-mono);
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.08em;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .logo-icon {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    overflow: hidden;
    flex-shrink: 0;
  }
  .logo-icon svg {
    width: 100%;
    height: 100%;
  }

  .header-stats {
    display: flex;
    gap: 16px;
    margin-left: auto;
    align-items: center;
  }

  .stat-chip {
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    color: var(--text2);
    background: var(--surface2);
    padding: 4px 10px;
    border-radius: 20px;
    border: 1px solid var(--border);
  }

  .stat-chip .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }
  .dot-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .dot-red { background: var(--red); }
  .dot-yellow { background: var(--yellow); }
  
  .connection-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 10px;
    font-weight: 600;
    font-family: var(--font-mono);
    letter-spacing: 0.05em;
    color: var(--text2);
    background: var(--surface2);
    padding: 2px 8px;
    border-radius: 12px;
    border: 1px solid var(--border);
    flex-shrink: 0;
  }
  .connection-status .dot {
    width: 4px;
    height: 4px;
    transition: all 0.3s;
    margin-top: -2px;
  }
  .connection-status.connected { background: var(--green-dim); color: var(--green); border-color: var(--green); }
  .connection-status.connected .dot { background: var(--green); }
  .connection-status.disconnected { background: var(--surface2); color: var(--text3); border: 1px solid var(--border); }
  .connection-status.disconnected .dot { background: var(--red); }
  .connection-status.connecting { background: rgba(94, 114, 228, 0.2); color: var(--accent); }
  .connection-status.connecting .dot { background: var(--yellow); animation: pulse 1s infinite; }

  .btn-new {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--accent);
    color: white;
    border: none;
    padding: 7px 14px;
    border-radius: 6px;
    font-family: var(--font-sans);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.15s, transform 0.1s;
  }
  .btn-new:hover { opacity: 0.85; }
  .btn-new:active { transform: scale(0.97); }

  .menu-toggle {
    display: none;
    background: none;
    border: none;
    color: var(--text);
    cursor: pointer;
    font-size: 20px;
    padding: 4px;
  }

  /* ── Sidebar ── */
  aside {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 16px 0;
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 56px;
    height: calc(100vh - 56px);
    width: 220px;
    transition: width 0.2s ease;
  }

  aside.collapsed { width: 48px; }
  aside.collapsed .sidebar-header { justify-content: center; padding: 0; }
  aside.collapsed .sidebar-label,
  aside.collapsed .nav-item > span:not(.nav-badge),
  aside.collapsed .nav-badge { display: none; }
  aside.collapsed .nav-item { justify-content: center; padding: 8px 0; gap: 0; font-size: 0; }
  aside.collapsed .sidebar-content { overflow: visible; }

  .shell.sidebar-collapsed { 
    --sidebar-width: 48px;
  }

  .sidebar-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 0 12px;
    margin-bottom: 8px;
  }
  .sidebar-collapse-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text3);
    cursor: pointer;
    transition: all 0.12s;
    flex-shrink: 0;
  }
  .sidebar-collapse-btn:hover { border-color: var(--border2); color: var(--text); }
  .sidebar-collapse-btn i { width: 12px; height: 12px; transition: transform 0.2s; }
  aside.collapsed .sidebar-collapse-btn i { transform: rotate(180deg); }
  aside.collapsed .sidebar-header .sidebar-label { display: none; }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
  }

  .sidebar-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text3);
    padding: 0 16px;
    margin-bottom: 8px;
    margin-top: 16px;
  }

  .sidebar-header .sidebar-label { padding: 0; margin: 0; }
  .sidebar-label:first-child { margin-top: 0; }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 16px;
    font-size: 13px;
    color: var(--text2);
    cursor: pointer;
    transition: all 0.12s;
    border-left: 2px solid transparent;
    user-select: none;
  }

  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--surface2); color: var(--text); border-left-color: var(--accent); }

  .nav-badge {
    margin-left: auto;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    padding: 1px 7px;
    font-size: 10px;
    font-family: var(--font-mono);
    color: var(--text3);
  }

  .nav-item i { width: 12px; height: 12px; stroke-width: 2; }

  .fab-btn i { width: 14px; height: 14px; stroke-width: 2.5; }
  .fab-item i { width: 12px; height: 12px; stroke-width: 2; }

  .ctx-item i { width: 10px; height: 10px; stroke-width: 2; }

  .folder-icon i { width: 12px; height: 12px; stroke-width: 2; color: var(--accent); }
  .folder-chevron i { width: 10px; height: 10px; stroke-width: 2.5; }

  /* ── Main ── */
  main {
    padding: 24px 24px 100px 24px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* ── System bar ── */
  .sysbar {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }

  .sys-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
  }

  .sys-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 4px;
  }

  .sys-value {
    font-family: var(--font-mono);
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }

  .sys-sub {
    font-size: 0.8125rem;
    color: var(--text3);
    margin-top: 2px;
    font-family: var(--font-mono);
  }

  /* ── Toolbar ── */
  .toolbar {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-box {
    flex: 1;
    min-width: 180px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    color: var(--text);
    font-family: var(--font-sans);
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s;
  }
  .search-box::placeholder { color: var(--text3); }
  .search-box:focus { border-color: var(--accent); }

  .filter-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 8px 14px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.12s;
    font-family: var(--font-sans);
  }
  .filter-btn.active, .filter-btn:hover { background: var(--surface2); color: var(--text); border-color: var(--border2); }
  .filter-btn.active { border-color: var(--accent); color: var(--accent); }

  /* ── Service cards ── */
  .services-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .svc-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.15s;
  }
  .svc-card:hover { border-color: var(--border2); }
  .svc-card.running { border-left: 3px solid var(--green); }
  .svc-card.stopped { border-left: 3px solid var(--border); }

  .svc-header {
    display: flex;
    align-items: center;
    padding: 14px 16px;
    gap: 12px;
    cursor: pointer;
    user-select: none;
  }

  .svc-status-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    flex-shrink: 0;
    transition: all 0.2s;
    cursor: default;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .svc-status-dot::before {
    content: '';
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    transition: all 0.2s;
  }
  .svc-status-dot::after {
    content: '⋮⋮';
    position: absolute;
    font-size: 8px;
    letter-spacing: -2px;
    color: transparent;
    transition: color 0.15s;
    font-family: monospace;
    line-height: 1;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  .status-running .svc-status-dot::before { background: var(--green); box-shadow: 0 0 8px var(--green); }
  .status-stopped .svc-status-dot::before { background: var(--text3); }
  .status-starting .svc-status-dot::before { background: var(--accent); animation: pulse 1s ease-in-out infinite; }
  .status-stopping .svc-status-dot::before { background: #f0b429; animation: pulse 0.5s ease-in-out infinite; }
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.3); }
  }
  @keyframes cardIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes scaleIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-8px); }
    to { opacity: 1; transform: translateX(0); }
  }
  @keyframes bounceIn {
    0% { opacity: 0; transform: scale(0.9) translateY(10px); }
    60% { transform: scale(1.02) translateY(-2px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
  }
  @keyframes statusRipple {
    0% { box-shadow: 0 0 0 0 var(--green); }
    100% { box-shadow: 0 0 0 12px transparent; }
  }
  @keyframes spinner {
    to { transform: rotate(360deg); }
  }
  
  .svc-card { animation: cardIn 0.25s ease-out; }
  .svc-card:nth-child(1) { animation-delay: 0ms; }
  .svc-card:nth-child(2) { animation-delay: 25ms; }
  .svc-card:nth-child(3) { animation-delay: 50ms; }
  .svc-card:nth-child(4) { animation-delay: 75ms; }
  .svc-card:nth-child(5) { animation-delay: 100ms; }
  
  .modal-content { animation: scaleIn 0.2s ease-out; }
  .toast-item { animation: bounceIn 0.3s ease-out, toastOut 0.2s ease 2.8s forwards; }
  
  .status-change .svc-status-dot::before { animation: statusRipple 0.4s ease-out; }
  .svc-header:hover .svc-status-dot {
    cursor: grab;
    transform: scale(1.15);
  }
  .svc-header:hover .svc-status-dot::before { opacity: 0.4; }
  .svc-header:hover .svc-status-dot::after { color: var(--text); }
  .svc-card.dragging .svc-status-dot { cursor: grabbing; transform: scale(1.25); }

  .svc-info { flex: 1; min-width: 0; }

  .svc-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    line-height: 1.2;
  }

  .svc-port {
    font-size: 0.8125rem;
    color: var(--blue);
  }

  .svc-meta {
    display: flex;
    gap: 12px;
    margin-top: 2px;
    flex-wrap: wrap;
  }

  .svc-meta span {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--text3);
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .svc-meta span.highlight { color: var(--blue); }

  .svc-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    font-family: var(--font-mono);
    letter-spacing: 0.05em;
    flex-shrink: 0;
  }
  .badge-running { background: var(--green-dim); color: var(--green); }
  .badge-stopped { background: var(--surface2); color: var(--text3); border: 1px solid var(--border); }
  .badge-starting { background: rgba(94, 114, 228, 0.2); color: var(--accent); }
  .badge-stopping { background: rgba(240, 180, 41, 0.2); color: #f0b429; }
  .ctrl-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .svc-controls {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-shrink: 0;
  }

  .ctrl-btn {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.12s;
    position: relative;
  }
  .ctrl-btn svg { width: 14px; height: 14px; stroke-width: 2; }
  .ctrl-btn:hover { background: var(--surface); color: var(--text); border-color: var(--border2); transform: translateY(-1px); }
  .ctrl-btn:active { transform: translateY(0) scale(0.95); }
  .ctrl-btn.start:hover { background: var(--green-dim); color: var(--green); border-color: var(--green); }
  .ctrl-btn.stop:hover { background: var(--red-dim); color: var(--red); border-color: var(--red); }
  .ctrl-btn.edit:hover { background: var(--blue-dim); color: var(--blue); border-color: var(--blue); }
  .ctrl-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
  .ctrl-btn.loading { pointer-events: none; }
  .ctrl-btn.loading::after {
    content: '';
    position: absolute;
    width: 14px;
    height: 14px;
    border: 2px solid var(--border);
    border-top-color: var(--text);
    border-radius: 50%;
    animation: spinner 0.6s linear infinite;
  }
  .ctrl-btn.loading svg, .ctrl-btn.loading span { visibility: hidden; }

  /* ── Expandable panel ── */
  .svc-panel {
    border-top: 1px solid var(--border);
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: max-height 0.25s ease-out, opacity 0.2s ease-out;
  }
  .svc-panel.open { 
    max-height: 500px;
    opacity: 1;
  }

  .panel-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 16px;
    gap: 0;
  }

  .panel-tab {
    padding: 8px 14px;
    font-size: 12px;
    color: var(--text3);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.12s;
  }
  .panel-tab.active { color: var(--text); border-bottom-color: var(--accent); }

  .panel-body { padding: 16px; }

  /* ── Log terminal ── */
  .log-terminal {
    background: #0a0c11;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    line-height: 1.6;
    height: 200px;
    overflow-y: auto;
    color: var(--text2);
  }

  .log-line { padding: 1px 0; }
  .log-line .time { color: var(--text3); }
  .log-line.err { color: var(--red); }
  .log-line.sys { color: var(--yellow); }
  
  .log-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    align-items: center;
  }
  
  .log-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text2);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.12s;
  }
  .log-btn:hover { color: var(--text); border-color: var(--border2); }
  .log-btn.active { color: var(--accent); border-color: var(--accent); }
  .log-btn.copied { color: var(--green); border-color: var(--green); }
  
  .theme-select {
    width: 100%;
    padding: 10px 12px;
    font-size: 13px;
    color: var(--text);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.15s;
  }
  .theme-select:hover { border-color: var(--border2); }
  .theme-select:focus { border-color: var(--accent); }
  .theme-select option {
    background: var(--surface);
    color: var(--text);
    padding: 8px;
  }

  .theme-colors-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  .theme-color-input {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .theme-color-input label {
    font-size: 10px;
    color: var(--text2);
    text-transform: capitalize;
  }
  .theme-color-input input {
    width: 100%;
    height: 32px;
    border: 1px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    background: var(--surface);
  }
  
  .svc-meta .warn { color: var(--yellow); font-weight: 600; }

  .log-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  /* ── Details grid ── */
  .detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .detail-item label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text3);
    display: block;
    margin-bottom: 3px;
  }

  .detail-item .val {
    font-family: var(--font-mono);
    font-size: 12px;
    color: var(--text);
    background: var(--surface2);
    padding: 6px 10px;
    border-radius: 4px;
    border: 1px solid var(--border);
    word-break: break-all;
  }

  /* ── Modal ── */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s;
  }
  .modal-backdrop.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 10px;
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    transform: translateY(8px);
    transition: transform 0.15s;
    box-shadow: 0 24px 64px rgba(0,0,0,0.6);
  }
  .modal-backdrop.open .modal { transform: translateY(0); }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 20px;
    border-bottom: 1px solid var(--border);
  }

  .modal-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--text3);
    cursor: pointer;
    line-height: 1;
    padding: 4px;
    transition: color 0.12s;
  }
  .modal-close svg { width: 14px; height: 14px; }
  .modal-close:hover { color: var(--text); }

  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 14px; text-align: left; }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group.full { grid-column: 1 / -1; }

  .form-group label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text3);
  }

  .form-input, .form-select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 12px;
    color: var(--text);
    font-family: var(--font-sans);
    font-size: 13px;
    outline: none;
    transition: border-color 0.15s;
    width: 100%;
  }
  .form-input::placeholder { color: var(--text3); }
  .form-input:focus, .form-select:focus { border-color: var(--accent); }
  .form-select { cursor: pointer; }

  .form-input.mono { font-family: var(--font-mono); font-size: 12px; }

  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
  }

  .toggle-label { font-size: 13px; color: var(--text2); }
  .toggle-sub { font-size: 11px; color: var(--text3); margin-top: 1px; }

  .toggle {
    width: 40px;
    height: 22px;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 11px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .toggle.on { background: var(--accent); border-color: var(--accent); }
  .toggle::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: left 0.2s;
  }
  .toggle.on::after { left: 20px; }

  .modal-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .btn-delete {
    background: transparent;
    border: 1px solid var(--red);
    color: var(--red);
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    font-family: var(--font-sans);
    transition: all 0.12s;
    display: none;
    align-items: center;
    gap: 6px;
  }
  .btn-delete:hover { background: var(--red-dim); }
  .btn-delete svg { width: 14px; height: 14px; }

  .modal-footer-right {
    margin-left: auto;
    display: flex;
    gap: 10px;
  }

  .btn-cancel {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 8px 18px;
    border-radius: 6px;
    font-size: 13px;
    cursor: pointer;
    font-family: var(--font-sans);
    transition: all 0.12s;
  }
  .btn-cancel:hover { color: var(--text); border-color: var(--border2); }

  .btn-save {
    background: var(--accent);
    border: none;
    color: white;
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    font-family: var(--font-sans);
    transition: opacity 0.12s;
  }
  .btn-save:hover { opacity: 0.85; }

  /* ── Port link ── */
  .port-link {
    color: var(--blue);
    text-decoration: none;
    font-family: var(--font-mono);
    font-size: 0.8125rem;
    display: inline-flex;
    align-items: center;
    gap: 3px;
  }
  .port-link:hover { text-decoration: underline; }

  /* ── Empty state ── */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text3);
  }
  .empty-state h3 { font-size: 15px; color: var(--text2); margin-bottom: 8px; font-weight: 500; }
  .empty-state p { font-size: 13px; }

  /* ── Toast ── */
  #toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 8px;
    pointer-events: none;
  }

  .toast-item {
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 13px;
    color: var(--text);
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    animation: toastIn 0.2s ease, toastOut 0.2s ease 2.8s forwards;
    max-width: 300px;
  }
  .toast-item.success { border-left: 3px solid var(--green); }
  .toast-item.error { border-left: 3px solid var(--red); }

  @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes toastOut { from { opacity: 1; } to { opacity: 0; } }

  /* ── FAB (Floating Action Button) ── */
  .fab-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 50;
  }

  .fab-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(94, 114, 228, 0.4);
    transition: all 0.2s;
    z-index: 51;
  }
  .fab-btn:hover { transform: scale(1.05); }
  .fab-btn.open { transform: rotate(45deg); }

  .fab-menu {
    position: absolute;
    bottom: 60px;
    right: 0;
    display: flex;
    flex-direction: column-reverse;
    gap: 8px;
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
    transition: all 0.2s;
  }
  .fab-menu.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: all;
  }

  .fab-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 10px 16px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  .fab-item:hover { background: var(--surface2); border-color: var(--border2); }
  .fab-item span:first-child { font-size: 14px; }
  .fab-item span:last-child { font-size: 12px; color: var(--text2); }

  /* ── Folder cards ── */
  .folder-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 4px;
    overflow: hidden;
  }

  .folder-header {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    gap: 10px;
    cursor: pointer;
    user-select: none;
    background: var(--surface2);
    border-bottom: 1px solid transparent;
    transition: all 0.12s;
    position: relative;
  }
  .folder-header:hover { background: var(--surface); }

  .folder-chevron {
    color: var(--text3);
    transition: transform 0.2s;
    width: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .folder-card.expanded .folder-chevron { transform: rotate(90deg); }

  .folder-icon {
    color: var(--accent);
    display: flex;
    align-items: center;
  }

  .folder-name {
    flex: 1;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text);
  }

  .folder-count {
    font-size: 11px;
    color: var(--text3);
    background: var(--surface);
    padding: 2px 8px;
    border-radius: 10px;
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
  }

  .folder-count.hidden {
    display: none;
  }

  .folder-actions {
    display: flex;
    gap: 4px;
    opacity: 1;
    transition: opacity 0.15s;
    margin-right: auto;
    margin-left: 8px;
  }
  .folder-header:hover .folder-actions { opacity: 1; }

  .folder-action-btn {
    width: 32px;
    height: 32px;
    border-radius: 5px;
    border: none;
    background: var(--surface);
    color: var(--text3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.12s;
  }
  .folder-action-btn svg { width: 12px; height: 12px; stroke-width: 2; }
  .folder-action-btn:hover { color: var(--text); background: var(--surface2); transform: scale(1.05); }
  .folder-action-btn:active { transform: scale(0.95); }
  .folder-action-btn.start:hover { color: var(--green); background: var(--green-dim); }
  .folder-action-btn.stop:hover { color: var(--red); background: var(--red-dim); }
  .folder-action-btn.edit:hover { color: var(--blue); }

  .folder-body {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.25s ease-out, padding 0.25s ease-out;
    padding: 0 8px;
    background: rgba(0,0,0,0.1);
  }
  .folder-card.expanded .folder-body {
    grid-template-rows: 1fr;
    padding: 8px;
  }
  .folder-body-inner {
    overflow: hidden;
  }
  .folder-card.drag-over .folder-body { background: var(--accent-glow); }

  .folder-body .svc-card { margin-bottom: 10px; }
  .folder-body .svc-card:last-child { margin-bottom: 0; }

  .drop-zone .svc-card { margin-bottom: 10px; }
  .drop-zone .svc-card:last-child { margin-bottom: 0; }

  .svc-card.dragging {
    opacity: 0.5;
    border-style: dashed;
  }

  .drop-zone {
    min-height: 40px;
    border: 2px dashed transparent;
    border-radius: 6px;
    transition: all 0.15s;
    margin-top: 8px;
  }
  .drop-zone.drag-over {
    border-color: var(--accent);
    background: var(--accent-glow);
  }

  /* ── Context menu ── */
  .context-menu {
    position: fixed;
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    z-index: 300;
    min-width: 160px;
    padding: 4px 0;
    display: none;
  }
  .context-menu.open { display: block; }

  .ctx-item {
    padding: 8px 14px;
    font-size: 13px;
    color: var(--text2);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.1s;
  }
  .ctx-item:hover { background: var(--surface2); color: var(--text); }
  .ctx-item.danger:hover { background: var(--red-dim); color: var(--red); }

  .ctx-divider {
    height: 1px;
    background: var(--border);
    margin: 4px 0;
  }

  /* ── Sidebar actions ── */
  .sidebar-actions {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-btn {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.12s;
    margin-bottom: 8px;
  }
  .sidebar-btn:last-child { margin-bottom: 0; }
  .sidebar-btn:hover { border-color: var(--border2); background: var(--surface); }
  .sidebar-btn.primary { background: var(--accent); border-color: var(--accent); }
  .sidebar-btn.primary:hover { opacity: 0.85; }

  /* ── Sidebar settings ── */
  .sidebar-section {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
    margin-top: 8px;
  }

  .sidebar-section-title {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 10px;
  }

  .sidebar-settings-row {
    display: flex;
    gap: 6px;
  }

  .sidebar-opt {
    flex: 1;
    padding: 6px 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 10px;
    color: var(--text2);
    cursor: pointer;
    text-align: center;
    transition: all 0.12s;
  }
  .sidebar-opt:hover { border-color: var(--border2); }
  .sidebar-opt.active { background: var(--accent); border-color: var(--accent); color: white; }

  /* ── Folder badge on service ── */
  .folder-badge {
    font-size: 10px;
    color: var(--accent);
    background: var(--accent-glow);
    padding: 1px 6px;
    border-radius: 4px;
    margin-left: 6px;
  }

  /* ── Responsive ── */
  @media (max-width: 768px) {
    .shell { grid-template-columns: 1fr; grid-template-rows: 56px 1fr; }
    aside { display: none; position: fixed; left: 0; top: 56px; bottom: 0; width: 240px; z-index: 150; }
    aside.open { display: block; }
    .menu-toggle { display: flex; }
    .sysbar { grid-template-columns: repeat(2, 1fr); }
    .form-row { grid-template-columns: 1fr; }
    .detail-grid { grid-template-columns: 1fr; }
    .header-stats .stat-chip:not(:first-child) { display: none; }
    main { padding: 14px 14px 100px 14px; }
  }

  @media (max-width: 480px) {
    .sysbar { grid-template-columns: 1fr 1fr; }
    .svc-controls .ctrl-btn { width: 26px; height: 26px; font-size: 0; }
    .svc-controls .ctrl-btn svg { width: 12px; height: 12px; }
    .svc-header { padding: 10px 12px; }
    .btn-cancel, .btn-save { padding: 10px 16px; font-size: 13px; }
    .btn-delete { flex: 1; background: var(--red); color: white; border-color: var(--red); }
    .modal-footer { flex-direction: row; gap: 10px; }
    .modal-footer-right { flex: 1; }
    .modal-footer-right .btn-cancel { display: none; }
    .modal-footer-right .btn-save { flex: 1; }
  }
</style>
</head>
<body>

<div class="shell">

  <!-- Header -->
  <header>
    <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
    <div class="logo">
      <div class="logo-icon">
        <svg width="48" height="48" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#1a1e28"/>
              <stop offset="100%" style="stop-color:#0d0f14"/>
            </linearGradient>
            <linearGradient id="accentGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#7b8ff5"/>
              <stop offset="100%" style="stop-color:#5e72e4"/>
            </linearGradient>
            <linearGradient id="greenGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:#2eea8a"/>
              <stop offset="100%" style="stop-color:#22d47a"/>
            </linearGradient>
          </defs>
          <rect width="512" height="512" rx="96" fill="url(#bgGrad)"/>
          <circle cx="256" cy="256" r="200" fill="none" stroke="#252a38" stroke-width="6"/>
          <circle cx="256" cy="256" r="160" fill="none" stroke="#1e2334" stroke-width="4"/>
          <circle cx="256" cy="248" r="100" fill="none" stroke="#252a38" stroke-width="16"/>
          <path d="M 256 148 A 100 100 0 1 1 256 348" fill="none" stroke="url(#accentGrad)" stroke-width="10" stroke-linecap="round"/>
          <rect x="240" y="188" width="32" height="90" rx="16" fill="url(#accentGrad)"/>
          <circle cx="380" cy="150" r="18" fill="#0d0f14" stroke="#1a1e28" stroke-width="3"/>
          <circle cx="380" cy="150" r="12" fill="url(#greenGrad)"/>
        </svg>
      </div>
      WinCTL
    </div>
    <div class="header-stats">
      <div class="connection-status connected" id="connection-status">
        <span class="dot"></span>
        <span class="label">Connected</span>
      </div>
      <div class="stat-chip"><span class="dot dot-green"></span><span id="stat-running">0</span> running</div>
      <div class="stat-chip"><span class="dot dot-red"></span><span id="stat-stopped">0</span> stopped</div>
      <div class="stat-chip" id="stat-host">—</div>
    </div>

  </header>

  <!-- Sidebar -->
  <aside id="sidebar">
    <div class="sidebar-header">
      <button class="sidebar-collapse-btn" onclick="toggleSidebarCollapse()" title="Toggle sidebar">
        <i data-lucide="chevron-left"></i>
      </button>
      <div class="sidebar-label">Views</div>
    </div>
    <div class="sidebar-content">
      <div class="nav-item active" onclick="setView('all', this)">
        <i data-lucide="layout-grid"></i> All Services <span class="nav-badge" id="nb-all">0</span>
      </div>
      <div class="nav-item" onclick="setView('running', this)">
        <i data-lucide="play"></i> Running <span class="nav-badge" id="nb-running">0</span>
      </div>
      <div class="nav-item" onclick="setView('stopped', this)">
        <i data-lucide="square"></i> Stopped <span class="nav-badge" id="nb-stopped">0</span>
      </div>
      <div class="sidebar-label">Actions</div>
      <div class="nav-item" onclick="startAll()"><i data-lucide="fast-forward"></i> Start All</div>
      <div class="nav-item" onclick="stopAll()"><i data-lucide="skip-back"></i> Stop All</div>
      <div class="nav-item" onclick="loadSystem()"><i data-lucide="cpu"></i> System Info</div>
    </div>
    <div style="margin-top: auto; padding: 16px;padding-left: 0px;padding-right: 0px;">
      <div class="nav-item" onclick="openSettingsModal()" >
        <i data-lucide="settings"></i> Settings
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main>

    <!-- System stats -->
    <div class="sysbar" id="sysbar">
      <div class="sys-card">
        <div class="sys-label">CPU Cores</div>
        <div class="sys-value" id="sys-cpu">—</div>
        <div class="sys-sub" id="sys-host">—</div>
      </div>
      <div class="sys-card">
        <div class="sys-label">Memory</div>
        <div class="sys-value" id="sys-mem">—</div>
        <div class="sys-sub" id="sys-memfree">—</div>
      </div>
      <div class="sys-card">
        <div class="sys-label">Services</div>
        <div class="sys-value" id="sys-svc">—</div>
        <div class="sys-sub">total registered</div>
      </div>
      <div class="sys-card">
        <div class="sys-label">Uptime</div>
        <div class="sys-value" id="sys-uptime">—</div>
        <div class="sys-sub">system uptime</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <input type="text" class="search-box" id="search" placeholder="Search services…" oninput="renderServices()">
      <button class="filter-btn active" data-filter="all" onclick="setFilter('all', this)">All</button>
      <button class="filter-btn" data-filter="running" onclick="setFilter('running', this)">Running</button>
      <button class="filter-btn" data-filter="stopped" onclick="setFilter('stopped', this)">Stopped</button>
    </div>

    <!-- Services -->
    <div class="services-grid" id="services-list"></div>

  </main>
</div>

<!-- Toast container -->
<div id="toast"></div>

<!-- FAB -->
<div class="fab-container">
  <div class="fab-menu" id="fab-menu">
    <div class="fab-item" onclick="openFolderModal(); toggleFab()">
      <i data-lucide="folder-plus"></i><span>New Folder</span>
    </div>
    <div class="fab-item" onclick="openModal(); toggleFab()">
      <i data-lucide="plus"></i><span>New Service</span>
    </div>
  </div>
  <button class="fab-btn" onclick="toggleFab()" id="fab-btn"><i data-lucide="plus"></i></button>
</div>

<!-- Context menu -->
<div class="context-menu" id="context-menu">
  <div class="ctx-item" onclick="ctxCreateFolder()"><i data-lucide="folder-plus"></i> New Folder</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item" onclick="ctxEditFolder()"><i data-lucide="pencil"></i> Rename</div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal" onclick="handleBackdropClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">New Service</div>
      <button class="modal-close" onclick="closeModal()"><i data-lucide="x"></i></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-id">

      <div class="form-row">
        <div class="form-group">
          <label>Service Name *</label>
          <input type="text" class="form-input" id="f-name" placeholder="My App">
        </div>
        <div class="form-group">
          <label>Port</label>
          <input type="text" class="form-input mono" id="f-port" placeholder="3000">
        </div>
      </div>

      <div class="form-group full">
        <label>Executable / Command *</label>
        <input type="text" class="form-input mono" id="f-command" placeholder="C:\path\to\app.exe  or  node">
      </div>

      <div class="form-group">
        <label>Arguments</label>
        <input type="text" class="form-input mono" id="f-args" placeholder="server.js --port 3000">
      </div>

      <div class="form-group">
        <label>Working Directory</label>
        <input type="text" class="form-input mono" id="f-cwd" placeholder="C:\myapp">
      </div>

      <div class="form-group">
        <label>Description</label>
        <input type="text" class="form-input" id="f-desc" placeholder="What does this do?">
      </div>

      <div class="toggle-row">
        <div>
          <div class="toggle-label">Auto-restart on crash</div>
          <div class="toggle-sub">Exponential backoff up to 30s</div>
        </div>
        <div class="toggle" id="toggle-autorestart" onclick="this.classList.toggle('on')"></div>
      </div>

      <div class="toggle-row">
        <div>
          <div class="toggle-label">Start on WinCTL boot</div>
          <div class="toggle-sub">Launch automatically when WinCTL starts</div>
        </div>
        <div class="toggle" id="toggle-autostart" onclick="this.classList.toggle('on')"></div>
      </div>

      <div class="toggle-row" id="minimized-row" style="display: none;">
        <div>
          <div class="toggle-label">Start minimized</div>
          <div class="toggle-sub">Launch application minimized to taskbar</div>
        </div>
        <div class="toggle" id="toggle-minimized" onclick="this.classList.toggle('on')"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-delete" id="service-delete-btn" onclick="deleteServiceFromModal()"><i data-lucide="trash-2"></i> Delete</button>
      <div class="modal-footer-right">
        <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="btn-save" onclick="saveService()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Folder Modal -->
<div class="modal-backdrop" id="folder-modal" onclick="handleFolderBackdropClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="folder-modal-title">New Folder</div>
      <button class="modal-close" onclick="closeFolderModal()"><i data-lucide="x"></i></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="folder-edit-id">
      <div class="form-group">
        <label>Folder Name *</label>
        <input type="text" class="form-input" id="folder-name" placeholder="My Folder">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" id="folder-delete-btn" style="background: var(--red); color: white; display: none;" onclick="deleteFolderFromModal()">Delete Folder</button>
      <div style="margin-left: auto;">
        <button class="btn-cancel" onclick="closeFolderModal()">Cancel</button>
        <button class="btn-save" onclick="saveFolder()">Save Folder</button>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-backdrop" id="settings-modal" onclick="handleSettingsBackdropClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Settings</div>
      <button class="modal-close" onclick="closeSettingsModal()"><i data-lucide="x"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Theme</label>
        <select class="theme-select" id="theme-select" onchange="selectTheme(this.value)"></select>
      </div>
      
      <div class="form-group">
        <label>Folder Default State</label>
        <div class="sidebar-settings-row">
          <button class="sidebar-opt active" data-value="remember" onclick="setFolderStatePref('remember', this)">Remember</button>
          <button class="sidebar-opt" data-value="collapsed" onclick="setFolderStatePref('collapsed', this)">Collapsed</button>
          <button class="sidebar-opt" data-value="expanded" onclick="setFolderStatePref('expanded', this)">Expanded</button>
        </div>
        <div style="font-size:11px;color:var(--text3);margin-top:6px;">How folders should appear when loaded</div>
      </div>
      
      <div class="toggle-row">
        <div>
          <div class="toggle-label">Show folder count</div>
          <div class="toggle-sub">Display number of items in each folder</div>
        </div>
        <div class="toggle ${settings.showFolderCount !== false ? 'on' : ''}" onclick="toggleFolderCount(this)"></div>
      </div>
      
      <div class="toggle-row">
        <div>
          <div class="toggle-label">WinCTL Auto-start</div>
          <div class="toggle-sub">Start WinCTL with Windows</div>
        </div>
        <div class="toggle ${settings.autoStart ? 'on' : ''}" onclick="toggleAutoStart(this)"></div>
      </div>
      
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
        <div style="font-size:11px;color:var(--text3);margin-bottom:8px;">Keyboard Shortcuts</div>
        <div style="font-size:11px;color:var(--text2);display:grid;grid-template-columns:1fr 1fr;gap:4px;">
          <span><kbd style="background:var(--surface2);padding:1px 4px;border-radius:3px;">Ctrl+K</kbd> Search</span>
          <span><kbd style="background:var(--surface2);padding:1px 4px;border-radius:3px;">Shift+N</kbd> New service</span>
          <span><kbd style="background:var(--surface2);padding:1px 4px;border-radius:3px;">Shift+F</kbd> New folder</span>
          <span><kbd style="background:var(--surface2);padding:1px 4px;border-radius:3px;">Esc</kbd> Close modal</span>
          <span><kbd style="background:var(--surface2);padding:1px 4px;border-radius:3px;">?</kbd> Settings</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="openThemeCreator()">Create Theme</button>
      <button class="btn-save" onclick="closeSettingsModal()">Close</button>
    </div>
  </div>
</div>

<!-- Theme Creator Modal -->
<div class="modal-backdrop" id="theme-creator-modal" onclick="handleThemeCreatorBackdropClick(event)">
  <div class="modal" style="max-width:500px;">
    <div class="modal-header">
      <div class="modal-title">Create Theme</div>
      <button class="modal-close" onclick="closeThemeCreator()"><i data-lucide="x"></i></button>
    </div>
    <div class="modal-body" id="theme-creator-body">
      <div class="form-group">
        <label>Theme Name *</label>
        <input type="text" class="form-input" id="theme-name" placeholder="My Theme">
      </div>
      <div class="form-group">
        <label>Author</label>
        <input type="text" class="form-input" id="theme-author" placeholder="Your name">
      </div>
      <div class="theme-colors-grid" id="theme-colors-grid"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeThemeCreator()">Cancel</button>
      <button class="btn-save" onclick="saveCustomTheme()">Save Theme</button>
    </div>
  </div>
</div>

<script>
const socket = io();
let services = [];
let folders = [];
let settings = { folderStatePreference: 'remember', showFolderCount: true };
let currentFilter = 'all';
let currentView = 'all';
let editingId = null;
let editingFolderId = null;
let openPanels = new Set();
let panelTabs = {};
let expandedFolders = new Set(JSON.parse(localStorage.getItem('expandedFolders') || '[]'));
let draggedServiceId = null;
let contextFolderId = null;

// ── Socket ─────────────────────────────────────────────────────────────────
socket.on('status', data => {
  services = data.services || data;
  folders = data.folders || [];
  const oldTheme = settings.theme;
  settings = data.settings || settings;
  
  // Apply theme if it changed and themes are loaded
  if (settings.theme && settings.theme !== oldTheme && themes.length > 0) {
    const theme = themes.find(t => t.id === settings.theme);
    if (theme) {
      currentTheme = settings.theme;
      applyTheme(theme.colors);
    }
  }
  
  applyFolderStatePreference();
  renderServices();
  updateStats();
});

socket.on('connect', () => loadServices());

// ── Sidebar Collapse ─────────────────────────────────────────────────────────
function toggleSidebarCollapse() {
  const aside = document.querySelector('aside');
  const shell = document.querySelector('.shell');
  aside.classList.toggle('collapsed');
  shell.classList.toggle('sidebar-collapsed');
  localStorage.setItem('sidebarCollapsed', aside.classList.contains('collapsed'));
}

function initSidebarState() {
  if (localStorage.getItem('sidebarCollapsed') === 'true') {
    document.querySelector('aside').classList.add('collapsed');
    document.querySelector('.shell').classList.add('sidebar-collapsed');
  }
}
document.addEventListener('DOMContentLoaded', initSidebarState);

// ── Load ───────────────────────────────────────────────────────────────────
async function loadServices() {
  const [svcRes, folderRes, settingsRes, autoStartRes] = await Promise.all([
    fetch('/api/services'),
    fetch('/api/folders'),
    fetch('/api/settings'),
    fetch('/api/autostart')
  ]);
  services = await svcRes.json();
  folders = await folderRes.json();
  const oldTheme = settings.theme;
  settings = await settingsRes.json();
  
  // Sync autostart from Windows registry
  const autoStartData = await autoStartRes.json();
  settings.autoStart = autoStartData.enabled;
  
  // Apply theme if it changed and themes are loaded
  if (settings.theme && settings.theme !== oldTheme && themes.length > 0) {
    const theme = themes.find(t => t.id === settings.theme);
    if (theme) {
      currentTheme = settings.theme;
      applyTheme(theme.colors);
    }
  }
  
  applyFolderStatePreference();
  renderServices();
  updateStats();
}

async function loadSystem() {
  const res = await fetch('/api/system');
  const sys = await res.json();
  document.getElementById('sys-cpu').textContent = sys.cpus;
  document.getElementById('sys-host').textContent = sys.hostname;
  document.getElementById('sys-mem').textContent = formatBytes(sys.totalMem, 0);
  document.getElementById('sys-memfree').textContent = formatBytes(sys.freeMem, 0) + ' free';
  document.getElementById('sys-uptime').textContent = formatUptime(sys.uptime);
  document.getElementById('stat-host').textContent = sys.hostname;
}

loadSystem();
setInterval(loadSystem, 10000);

// ── Folder state preference ────────────────────────────────────────────────
function applyFolderStatePreference() {
  if (settings.folderStatePreference === 'expanded') {
    folders.forEach(f => expandedFolders.add(f.id));
  } else if (settings.folderStatePreference === 'collapsed') {
    expandedFolders.clear();
  }
  // 'remember' - keep current state
}

async function setFolderStatePref(value, el) {
  settings.folderStatePreference = value;
  document.querySelectorAll('#settings-modal .sidebar-opt').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  await fetch('/api/settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(settings)
  });
  applyFolderStatePreference();
  renderServices();
}

async function toggleFolderCount(el) {
  settings.showFolderCount = !settings.showFolderCount;
  el.classList.toggle('on', settings.showFolderCount);
  await fetch('/api/settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(settings)
  });
  renderServices();
}

async function toggleAutoStart(el) {
  settings.autoStart = !settings.autoStart;
  el.classList.toggle('on', settings.autoStart);
  await fetch('/api/settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(settings)
  });
  // Also call the actual autostart API
  const action = settings.autoStart ? 'enable' : 'disable';
  try {
    await fetch(`/api/autostart/${action}`, { method: 'POST' });
  } catch (e) {
    console.error('Failed to update autostart:', e);
  }
  toast(`WinCTL auto-start ${settings.autoStart ? 'enabled' : 'disabled'}`);
}

// ── FAB ─────────────────────────────────────────────────────────────────────
function toggleFab() {
  document.getElementById('fab-menu').classList.toggle('open');
  document.getElementById('fab-btn').classList.toggle('open');
}

document.addEventListener('click', (e) => {
  const fab = document.querySelector('.fab-container');
  if (fab && !fab.contains(e.target)) {
    document.getElementById('fab-menu')?.classList.remove('open');
    document.getElementById('fab-btn')?.classList.remove('open');
  }
});

// ── Render ─────────────────────────────────────────────────────────────────
function renderServices() {
  const q = document.getElementById('search').value.toLowerCase();
  let list = services.filter(s => {
    const matchSearch = !q || s.name.toLowerCase().includes(q) || (s.command||'').toLowerCase().includes(q) || (s.description||'').toLowerCase().includes(q);
    const matchFilter = currentFilter === 'all' || s.status === currentFilter;
    return matchSearch && matchFilter;
  });

  const el = document.getElementById('services-list');

  if (!list.length && !folders.length) {
    el.innerHTML = `<div class="empty-state"><h3>No services found</h3><p>Add a service using the button in the sidebar, or adjust your filter.</p></div>`;
    return;
  }

  // Separate root services and folder services
  const rootServices = list.filter(s => !s.folderId);
  const folderMap = {};
  folders.forEach(f => { folderMap[f.id] = []; });
  list.forEach(s => {
    if (s.folderId && folderMap[s.folderId]) {
      folderMap[s.folderId].push(s);
    }
  });

  let html = '';

  // Render folders
  folders.forEach(f => {
    const folderServices = folderMap[f.id] || [];
    const isExpanded = expandedFolders.has(f.id);
    html += `
    <div class="folder-card ${isExpanded ? 'expanded' : ''}" 
         id="folder-${f.id}" 
         data-folder-id="${f.id}"
         ondragover="handleDragOver(event, '${f.id}')"
         ondragleave="handleDragLeave(event)"
         ondrop="handleDrop(event, '${f.id}')">
      <div class="folder-header" onclick="toggleFolder('${f.id}')" oncontextmenu="showFolderContext(event, '${f.id}')">
        <span class="folder-chevron"><i data-lucide="chevron-right"></i></span>
        <span class="folder-icon"><i data-lucide="folder"></i></span>
        <span class="folder-name">${escHtml(f.name)}</span>
        <div class="folder-actions" onclick="event.stopPropagation()">
           <button class="folder-action-btn start" title="Start All" onclick="folderAction('${f.id}', 'start')"><i data-lucide="play"></i></button>
           <button class="folder-action-btn stop" title="Stop All" onclick="folderAction('${f.id}', 'stop')"><i data-lucide="square"></i></button>
           <button class="folder-action-btn edit" title="Rename" onclick="openFolderModal('${f.id}')"><i data-lucide="pencil"></i></button>
        </div>
        <span class="folder-count ${settings.showFolderCount === false ? 'hidden' : ''}">${folderServices.length}</span>
      </div>
      <div class="folder-body">
        <div class="folder-body-inner">
          ${folderServices.map(s => renderCard(s, true)).join('')}
          ${folderServices.length === 0 ? '<div style="color:var(--text3);font-size:12px;padding:8px;text-align:center;">Drag services here</div>' : ''}
        </div>
      </div>
    </div>`;
  });

  // Render root services
  if (rootServices.length > 0) {
    html += `<div class="drop-zone" id="root-drop-zone" ondragover="handleDragOver(event, null)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, null)">`;
    rootServices.forEach(s => { html += renderCard(s, false); });
    html += `</div>`;
  } else if (folders.length > 0) {
    html += `<div class="drop-zone" id="root-drop-zone" ondragover="handleDragOver(event, null)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, null)" style="padding:20px;text-align:center;color:var(--text3);font-size:12px;">Drop here to remove from folder</div>`;
  }

  el.innerHTML = html;

  // Flush any buffered logs now that DOM elements exist
  services.forEach(s => flushLogBuffer(s.id));

  // Reopen panels
  openPanels.forEach(id => {
    const panel = document.getElementById(`panel-${id}`);
    if (panel) panel.classList.add('open');
    const tab = panelTabs[id] || 'logs';
    const tabEl = document.querySelector(`[data-tab="${id}-${tab}"]`);
    if (tabEl) tabEl.click();
  });

  updateStats();
  if (window.lucide) lucide.createIcons();
}

function renderCard(s, inFolder = false) {
  const isRunning = s.status === 'running';
  const isStarting = s.status === 'starting';
  const isStopping = s.status === 'stopping';
  const isTransitioning = isStarting || isStopping;
  const pid = s.pid ? `PID: ${s.pid}` : '';
  const portLink = s.port ? `<a class="port-link" href="http://localhost:${s.port}" target="_blank">:${s.port} ↗</a>` : '';
  const uptime = s.startedAt ? `up ${timeAgo(s.startedAt)}` : '';
  const restarts = s.restartCount ? `↺ ${s.restartCount}` : '';
  const folder = s.folderId ? folders.find(f => f.id === s.folderId) : null;
  
  const statusLabels = {
    running: 'RUNNING',
    stopped: 'STOPPED',
    starting: 'STARTING...',
    stopping: 'STOPPING...'
  };
  const badgeClass = isRunning ? 'badge-running' : isStarting ? 'badge-starting' : isStopping ? 'badge-stopping' : 'badge-stopped';

  return `
<div class="svc-card ${s.status}" id="card-${s.id}">
  <div class="svc-header status-${s.status}" onclick="togglePanel('${s.id}')">
    <div class="svc-status-dot" draggable="true" ondragstart="handleDragStart(event, '${s.id}')" ondragend="handleDragEnd(event)" title="Drag to move"></div>
    <div class="svc-info">
      <div class="svc-name">
        ${escHtml(s.name)}
        ${portLink ? `<span class="svc-port">${portLink}</span>` : ''}
        ${folder && !inFolder ? `<span class="folder-badge">${escHtml(folder.name)}</span>` : ''}
      </div>
      <div class="svc-meta">
        ${pid ? `<span>${pid}</span>` : ''}
        ${uptime ? `<span>${uptime}</span>` : ''}
        ${restarts ? `<span class="${s.restartCount > 3 ? 'warn' : ''}">${restarts}</span>` : ''}
      </div>
    </div>
    <span class="svc-badge ${badgeClass}">${statusLabels[s.status] || s.status.toUpperCase()}</span>
    <div class="svc-controls" onclick="event.stopPropagation()">
      ${!isRunning && !isTransitioning ? `<button class="ctrl-btn start" title="Start (S)" onclick="ctrl('${s.id}','start')"><i data-lucide="play"></i></button>` : ''}
      ${isRunning && !isTransitioning ? `<button class="ctrl-btn stop" title="Stop (S)" onclick="ctrl('${s.id}','stop')"><i data-lucide="square"></i></button>` : ''}
      ${isTransitioning ? `<button class="ctrl-btn loading" disabled><span></span></button>` : ''}
      <button class="ctrl-btn edit" title="Edit (E)" onclick="openModal('${s.id}')" ${isTransitioning ? 'disabled style="opacity:0.5"' : ''}><i data-lucide="pencil"></i></button>
    </div>
  </div>
  <div class="svc-panel" id="panel-${s.id}">
    <div class="panel-tabs">
      <div class="panel-tab active" data-tab="${s.id}-logs" onclick="switchTab('${s.id}','logs',this)">Logs</div>
      <div class="panel-tab" data-tab="${s.id}-details" onclick="switchTab('${s.id}','details',this)">Details</div>
    </div>
    <div class="panel-body" id="pbody-${s.id}">
      ${renderLogsPanel(s)}
    </div>
  </div>
</div>`;
}

function renderLogsPanel(s) {
  const logs = (s.recentLogs || []).slice(-100);
  const lines = logs.map(l => {
    const cls = l.line.includes('[ERR]') ? 'err' : l.line.includes('[SYS]') ? 'sys' : '';
    return `<div class="log-line ${cls}"><span class="time">${l.t.substring(11,19)}</span> ${escHtml(l.line)}</div>`;
  }).join('');
  return `
  <div class="log-controls">
    <button class="log-btn" onclick="copyLogs('${s.id}', this)" title="Copy logs to clipboard">📋 Copy</button>
    <button class="log-btn active" id="autoscroll-${s.id}" onclick="toggleAutoScroll('${s.id}', this)" title="Toggle auto-scroll">↓ Auto-scroll</button>
    <button class="log-btn" onclick="clearLogsUI('${s.id}')" title="Clear display">Clear</button>
  </div>
  <div class="log-terminal" id="logs-${s.id}" data-autoscroll="true">${lines || '<span style="color:var(--text3)">No output yet</span>'}</div>`;
}

function renderDetailsPanel(s) {
  const folder = s.folderId ? folders.find(f => f.id === s.folderId) : null;
  return `<div class="detail-grid">
    <div class="detail-item"><label>Command</label><div class="val">${escHtml(s.command)}</div></div>
    <div class="detail-item"><label>Arguments</label><div class="val">${escHtml(s.args||'—')}</div></div>
    <div class="detail-item"><label>Working Dir</label><div class="val">${escHtml(s.cwd||'(default)')}</div></div>
    <div class="detail-item"><label>Port</label><div class="val">${s.port ? `<a class="port-link" href="http://localhost:${s.port}" target="_blank">:${s.port} ↗</a>` : '—'}</div></div>
    <div class="detail-item"><label>Folder</label><div class="val">${folder ? escHtml(folder.name) : '—'}</div></div>
    <div class="detail-item"><label>Auto-restart</label><div class="val">${s.autoRestart ? '✓ Enabled' : '✕ Disabled'}</div></div>
    <div class="detail-item"><label>Process ID</label><div class="val">${s.pid||'—'}</div></div>
    <div class="detail-item"><label>Restart Count</label><div class="val">${s.restartCount||0}</div></div>
    <div class="detail-item"><label>Started At</label><div class="val">${s.startedAt||'—'}</div></div>
    <div class="detail-item"><label>Description</label><div class="val">${escHtml(s.description||'—')}</div></div>
  </div>`;
}

// ── Folders ────────────────────────────────────────────────────────────────
function toggleFolder(id) {
  if (expandedFolders.has(id)) {
    expandedFolders.delete(id);
  } else {
    expandedFolders.add(id);
  }
  localStorage.setItem('expandedFolders', JSON.stringify([...expandedFolders]));
  document.getElementById(`folder-${id}`)?.classList.toggle('expanded');
}

async function folderAction(id, action) {
  const res = await fetch(`/api/folders/${id}/${action}`, { method: 'POST' });
  const data = await res.json();
  toast(data.message || `${action} folder`, data.ok !== false ? 'success' : 'error');
}

async function deleteFolder(id) {
  const folder = folders.find(f => f.id === id);
  if (!folder) return;
  if (!confirm(`Delete folder "${folder.name}"?\nServices will be moved to root.`)) return;
  await fetch(`/api/folders/${id}`, { method: 'DELETE' });
  toast(`Deleted folder: ${folder.name}`);
}

async function deleteFolderFromModal() {
  const id = document.getElementById('folder-edit-id').value;
  if (!id) return;
  
  const folder = folders.find(f => f.id === id);
  if (!folder) return;
  
  if (!confirm(`Delete folder "${folder.name}"?\nServices will be moved to root.`)) return;
  
  await fetch(`/api/folders/${id}`, { method: 'DELETE' });
  toast(`Deleted folder: ${folder.name}`);
  closeFolderModal();
  loadServices(); // Refresh the services list
}

function openFolderModal(id) {
  editingFolderId = id || null;
  document.getElementById('folder-modal-title').textContent = id ? 'Rename Folder' : 'New Folder';
  
  // Show/hide delete button based on whether we're editing an existing folder
  const deleteBtn = document.getElementById('folder-delete-btn');
  deleteBtn.style.display = id ? 'block' : 'none';
  
  if (id) {
    const f = folders.find(x => x.id === id);
    if (f) {
      document.getElementById('folder-edit-id').value = f.id;
      document.getElementById('folder-name').value = f.name || '';
    }
  } else {
    document.getElementById('folder-edit-id').value = '';
    document.getElementById('folder-name').value = '';
  }
  
  document.getElementById('folder-modal').classList.add('open');
  setTimeout(() => document.getElementById('folder-name').focus(), 100);
}

function closeFolderModal() {
  document.getElementById('folder-modal').classList.remove('open');
}

function handleFolderBackdropClick(e) {
  if (e.target === document.getElementById('folder-modal')) closeFolderModal();
}

// Settings Modal Functions
function openSettingsModal() {
  document.getElementById('settings-modal').classList.add('open');
  updateSettingsUIInModal();
}

function closeSettingsModal() {
  document.getElementById('settings-modal').classList.remove('open');
}

function handleSettingsBackdropClick(e) {
  if (e.target === document.getElementById('settings-modal')) closeSettingsModal();
}

function updateSettingsUIInModal() {
  document.querySelectorAll('#settings-modal .sidebar-opt').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.value === settings.folderStatePreference);
  });
  
  const folderToggle = document.querySelector('#settings-modal .toggle');
  if (folderToggle) {
    folderToggle.classList.toggle('on', settings.showFolderCount !== false);
  }
  
  const autoStartToggle = document.querySelector('#settings-modal .toggle:last-of-type');
  if (autoStartToggle) {
    autoStartToggle.classList.toggle('on', settings.autoStart);
  }
}

async function saveFolder() {
  const name = document.getElementById('folder-name').value.trim();
  if (!name) { toast('Folder name is required', 'error'); return; }

  const id = document.getElementById('folder-edit-id').value;
  const url = id ? `/api/folders/${id}` : '/api/folders';
  const method = id ? 'PUT' : 'POST';
  
  await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  });
  
  closeFolderModal();
  toast(id ? 'Folder renamed' : 'Folder created', 'success');
}

// ── Context menu ───────────────────────────────────────────────────────────
function showFolderContext(e, id) {
  e.preventDefault();
  contextFolderId = id;
  const menu = document.getElementById('context-menu');
  menu.style.left = e.pageX + 'px';
  menu.style.top = e.pageY + 'px';
  menu.classList.add('open');
}

function hideContextMenu() {
  document.getElementById('context-menu').classList.remove('open');
  contextFolderId = null;
}

function ctxCreateFolder() {
  hideContextMenu();
  openFolderModal();
}

function ctxEditFolder() {
  if (contextFolderId) openFolderModal(contextFolderId);
  hideContextMenu();
}

document.addEventListener('click', hideContextMenu);

// ── Drag and drop ──────────────────────────────────────────────────────────
function handleDragStart(e, serviceId) {
  draggedServiceId = serviceId;
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', serviceId);
  document.getElementById(`card-${serviceId}`)?.classList.add('dragging');
}

function handleDragEnd(e) {
  document.querySelectorAll('.svc-card.dragging').forEach(el => el.classList.remove('dragging'));
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  draggedServiceId = null;
}

function handleDragOver(e, folderId) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  
  if (folderId) {
    document.getElementById(`folder-${folderId}`)?.classList.add('drag-over');
  } else {
    document.getElementById('root-drop-zone')?.classList.add('drag-over');
  }
}

function handleDragLeave(e) {
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
}

async function handleDrop(e, folderId) {
  e.preventDefault();
  
  document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
  
  if (!draggedServiceId) return;
  
  const service = services.find(s => s.id === draggedServiceId);
  if (!service) return;
  
  // Update service's folder
  await fetch(`/api/services/${draggedServiceId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ...service, folderId: folderId || null })
  });
  
  toast(folderId ? 'Moved to folder' : 'Moved to root', 'success');
  draggedServiceId = null;
}

// ── Panel / tabs ───────────────────────────────────────────────────────────
function togglePanel(id) {
  const panel = document.getElementById(`panel-${id}`);
  if (!panel) return;
  if (openPanels.has(id)) {
    openPanels.delete(id);
    panel.classList.remove('open');
  } else {
    openPanels.add(id);
    panel.classList.add('open');
    socket.emit('subscribe:logs', id);
    setTimeout(() => { const el = document.getElementById(`logs-${id}`); if(el) el.scrollTop = el.scrollHeight; }, 50);
  }
}

function switchTab(id, tab, el) {
  panelTabs[id] = tab;
  el.closest('.svc-panel').querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  const body = document.getElementById(`pbody-${id}`);
  const svc = services.find(s => s.id === id) || {};
  if (tab === 'logs') {
    body.innerHTML = renderLogsPanel(svc);
    flushLogBuffer(id);
  }
  if (tab === 'details') body.innerHTML = renderDetailsPanel(svc);
}

// Client-side log buffer for when element doesn't exist yet
const logBuffer = new Map();
const LOG_BUFFER_MAX = 100;

function flushLogBuffer(id) {
  const el = document.getElementById(`logs-${id}`);
  if (!el) return;
  const buffered = logBuffer.get(id);
  if (!buffered || buffered.length === 0) return;
  buffered.forEach(data => {
    const cls = data.line.includes('[ERR]') ? 'err' : data.line.includes('[SYS]') ? 'sys' : '';
    const line = document.createElement('div');
    line.className = `log-line ${cls}`;
    line.innerHTML = `<span class="time">${data.t.substring(11,19)}</span> ${escHtml(data.line)}`;
    el.appendChild(line);
  });
  logBuffer.delete(id);
  if (el.children.length > 200) {
    while (el.children.length > 200) el.removeChild(el.firstChild);
  }
  el.scrollTop = el.scrollHeight;
}

// Live log streaming
socket.onAny((event, data) => {
  if (!event.startsWith('log:')) return;
  const id = event.replace('log:', '');
  console.log(`[SOCKET] Received ${event}`, data);
  const el = document.getElementById(`logs-${id}`);
  if (!el) {
    // Buffer the log instead of dropping
    if (!logBuffer.has(id)) logBuffer.set(id, []);
    const buf = logBuffer.get(id);
    buf.push(data);
    if (buf.length > LOG_BUFFER_MAX) buf.shift();
    console.log(`[SOCKET] Buffered log for ${id} (buffer: ${buf.length})`);
    return;
  }
  const cls = data.line.includes('[ERR]') ? 'err' : data.line.includes('[SYS]') ? 'sys' : '';
  const line = document.createElement('div');
  line.className = `log-line ${cls}`;
  line.innerHTML = `<span class="time">${data.t.substring(11,19)}</span> ${escHtml(data.line)}`;
  el.appendChild(line);
  if (el.children.length > 200) el.removeChild(el.firstChild);
  if (el.dataset.autoscroll !== 'false') el.scrollTop = el.scrollHeight;
});

function clearLogsUI(id) {
  const el = document.getElementById(`logs-${id}`);
  if (el) el.innerHTML = '<span style="color:var(--text3)">Cleared.</span>';
}

// ── Controls ───────────────────────────────────────────────────────────────
async function ctrl(id, action) {
  const btn = document.querySelector(`#card-${id} .ctrl-btn.${action}`);
  if (btn) btn.classList.add('loading');
  
  try {
    const res = await fetch(`/api/services/${id}/${action}`, { method: 'POST' });
    if (!res.ok) toast(`${action} failed`, 'error');
  } finally {
    if (btn) btn.classList.remove('loading');
  }
}

async function deleteService(id, name) {
  if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
  
  try {
    const res = await fetch(`/api/services/${id}`, { method: 'DELETE' });
    if (res.ok) {
      toast('Service deleted', 'success');
      loadServices();
    } else {
      toast('Failed to delete', 'error');
    }
  } catch (e) {
    toast('Error deleting service', 'error');
  }
}

async function deleteService(id, name) {
  if (!confirm(`Delete "${name}"?\nThis will stop it if running.`)) return;
  await fetch(`/api/services/${id}`, { method: 'DELETE' });
  toast(`Deleted: ${name}`);
}

async function startAll() {
  const stopped = services.filter(s => s.status === 'stopped');
  for (const s of stopped) await ctrl(s.id, 'start');
  toast(`Started ${stopped.length} service(s)`, 'success');
}

async function stopAll() {
  const running = services.filter(s => s.status === 'running');
  for (const s of running) await ctrl(s.id, 'stop');
  toast(`Stopped ${running.length} service(s)`);
}

async function deleteServiceFromModal() {
  const id = document.getElementById('edit-id').value;
  if (!id) return;
  
  const service = services.find(s => s.id === id);
  if (!service) return;
  
  if (!confirm(`Delete "${service.name}"?\nThis will stop it if running.`)) return;
  
  await fetch(`/api/services/${id}`, { method: 'DELETE' });
  toast(`Deleted: ${service.name}`);
  closeModal();
  loadServices(); // Refresh the services list
}

// ── Modal ──────────────────────────────────────────────────────────────────
function openModal(id) {
  editingId = id || null;
  document.getElementById('modal-title').textContent = id ? 'Edit Service' : 'New Service';

  // Show/hide delete button based on whether we're editing an existing service
  const deleteBtn = document.getElementById('service-delete-btn');
  deleteBtn.style.display = id ? 'block' : 'none';

  if (id) {
    const s = services.find(x => x.id === id);
    if (s) {
      document.getElementById('edit-id').value = s.id;
      document.getElementById('f-name').value = s.name || '';
      document.getElementById('f-command').value = s.command || '';
      document.getElementById('f-args').value = s.args || '';
      document.getElementById('f-cwd').value = s.cwd || '';
      document.getElementById('f-port').value = s.port || '';
      document.getElementById('f-desc').value = s.description || '';
      document.getElementById('toggle-autorestart').classList.toggle('on', !!s.autoRestart);
      document.getElementById('toggle-autostart').classList.toggle('on', !!s.autoStart);
      document.getElementById('toggle-minimized').classList.toggle('on', !!s.minimized);
    }
  } else {
    document.getElementById('edit-id').value = '';
    ['f-name','f-command','f-args','f-cwd','f-port','f-desc'].forEach(id => { document.getElementById(id).value = ''; });
    document.getElementById('toggle-autorestart').classList.remove('on');
    document.getElementById('toggle-autostart').classList.remove('on');
    document.getElementById('toggle-minimized').classList.remove('on');
  }

  updateExeToggle();
  document.getElementById('modal').classList.add('open');
  if (window.lucide) lucide.createIcons();
  setTimeout(() => document.getElementById('f-name').focus(), 100);
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

function handleBackdropClick(e) {
  if (e.target === document.getElementById('modal')) closeModal();
}

async function saveService() {
  const name = document.getElementById('f-name').value.trim();
  const command = document.getElementById('f-command').value.trim();
  if (!name) { toast('Name is required', 'error'); return; }
  if (!command) { toast('Command is required', 'error'); return; }

  const id = document.getElementById('edit-id').value;
  const existing = services.find(s => s.id === id);
  
  const body = {
    name,
    command,
    args: document.getElementById('f-args').value.trim(),
    cwd: document.getElementById('f-cwd').value.trim(),
    port: document.getElementById('f-port').value.trim(),
    description: document.getElementById('f-desc').value.trim(),
    autoRestart: document.getElementById('toggle-autorestart').classList.contains('on'),
    autoStart: document.getElementById('toggle-autostart').classList.contains('on'),
    minimized: document.getElementById('toggle-minimized').classList.contains('on'),
    folderId: existing?.folderId || null,
  };

  const url = id ? `/api/services/${id}` : '/api/services';
  const method = id ? 'PUT' : 'POST';
  await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  closeModal();
  toast(id ? 'Service updated' : 'Service added', 'success');
}

// ── Filters / views ────────────────────────────────────────────────────────
function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderServices();
}

function setView(v, el) {
  currentView = v;
  currentFilter = v;
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderServices();
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// ── Stats ──────────────────────────────────────────────────────────────────
function updateStats() {
  const running = services.filter(s => s.status === 'running').length;
  const stopped = services.filter(s => s.status === 'stopped').length;
  document.getElementById('stat-running').textContent = running;
  document.getElementById('stat-stopped').textContent = stopped;
  document.getElementById('nb-all').textContent = services.length;
  document.getElementById('nb-running').textContent = running;
  document.getElementById('nb-stopped').textContent = stopped;
  document.getElementById('sys-svc').textContent = services.length;
}

// ── Toast ──────────────────────────────────────────────────────────────────
function toast(msg, type = '') {
  const el = document.createElement('div');
  el.className = `toast-item ${type}`;
  el.textContent = msg;
  document.getElementById('toast').appendChild(el);
  setTimeout(() => el.remove(), 3200);
}

// ── Utils ──────────────────────────────────────────────────────────────────
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatBytes(b, dec = 1) {
  if (b < 1024) return b + ' B';
  if (b < 1024**2) return (b/1024).toFixed(dec) + ' KB';
  if (b < 1024**3) return (b/1024**2).toFixed(dec) + ' MB';
  return (b/1024**3).toFixed(dec) + ' GB';
}

function formatUptime(s) {
  const d = Math.floor(s / 86400);
  const h = Math.floor((s % 86400) / 3600);
  if (d > 0) return `${d}d ${h}h`;
  if (h > 0) return `${h}h ${Math.floor((s%3600)/60)}m`;
  return `${Math.floor(s/60)}m`;
}

function timeAgo(iso) {
  const s = Math.floor((Date.now() - new Date(iso)) / 1000);
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s/60) + 'm';
  if (s < 86400) return Math.floor(s/3600) + 'h';
  return Math.floor(s/86400) + 'd';
}

// Command input listener to show/hide minimized toggle
document.getElementById('f-command').addEventListener('input', updateExeToggle);

function updateExeToggle() {
  const command = document.getElementById('f-command').value.trim();
  const minimizedRow = document.getElementById('minimized-row');
  
  if (command.toLowerCase().endsWith('.exe')) {
    minimizedRow.style.display = 'flex';
  } else {
    minimizedRow.style.display = 'none';
  }
}

// ── Theme System ─────────────────────────────────────────────────────────────
let themes = [];
let currentTheme = 'dark-default';

async function loadThemes() {
  try {
    const res = await fetch('/api/themes');
    themes = await res.json();
    renderThemeSelect();
  } catch (e) {
    console.error('Failed to load themes:', e);
  }
}

function renderThemeSelect() {
  const select = document.getElementById('theme-select');
  if (!select) return;

  // Sort themes: built-in first, then custom, alphabetically within groups
  const sorted = [...themes].sort((a, b) => {
    if (a.builtIn && !b.builtIn) return -1;
    if (!a.builtIn && b.builtIn) return 1;
    return a.name.localeCompare(b.name);
  });

  select.innerHTML = sorted.map(t =>
    `<option value="${t.id}" ${t.id === currentTheme ? 'selected' : ''}>${escHtml(t.name)}${t.builtIn ? '' : ' (Custom)'}</option>`
  ).join('');
}

async function selectTheme(id) {
  currentTheme = id;
  const theme = themes.find(t => t.id === id);
  if (!theme) return;

  applyTheme(theme.colors);

  // Update select to reflect current theme
  const select = document.getElementById('theme-select');
  if (select) select.value = id;

  settings.theme = id;
  await fetch('/api/settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(settings)
  });
  toast(`Theme: ${theme.name}`, 'success');
}

function applyTheme(colors) {
  const root = document.documentElement;
  Object.entries(colors).forEach(([key, value]) => {
    root.style.setProperty(`--${key}`, value);
  });
}

function openThemeCreator() {
  document.getElementById('theme-name').value = '';
  document.getElementById('theme-author').value = '';
  renderThemeColorInputs();
  document.getElementById('theme-creator-modal').classList.add('open');
}

function closeThemeCreator() {
  document.getElementById('theme-creator-modal').classList.remove('open');
}

function handleThemeCreatorBackdropClick(e) {
  if (e.target === document.getElementById('theme-creator-modal')) closeThemeCreator();
}

function renderThemeColorInputs() {
  const grid = document.getElementById('theme-colors-grid');
  const defaultTheme = themes.find(t => t.id === 'dark-default');
  const colors = defaultTheme?.colors || {};
  
  const colorKeys = ['bg', 'surface', 'surface2', 'border', 'text', 'text2', 'green', 'red', 'yellow', 'blue', 'accent'];
  
  grid.innerHTML = colorKeys.map(key => `
    <div class="theme-color-input">
      <label>${key}</label>
      <input type="color" id="tc-${key}" value="${rgbToHex(colors[key] || '#000000')}">
    </div>
  `).join('');
}

function rgbToHex(color) {
  if (color.startsWith('#')) return color.slice(0, 7);
  return '#000000';
}

async function saveCustomTheme() {
  const name = document.getElementById('theme-name').value.trim();
  if (!name) { toast('Theme name is required', 'error'); return; }
  
  const colorKeys = ['bg', 'surface', 'surface2', 'border', 'text', 'text2', 'green', 'red', 'yellow', 'blue', 'accent'];
  const colors = {};
  colorKeys.forEach(key => {
    colors[key] = document.getElementById(`tc-${key}`)?.value || '#000000';
  });
  colors['border2'] = colors['border'];
  colors['text3'] = colors['text2'];
  colors['green-dim'] = colors['green'] + '33';
  colors['red-dim'] = colors['red'] + '33';
  colors['yellow-dim'] = colors['yellow'] + '33';
  colors['blue-dim'] = colors['blue'] + '33';
  colors['accent-glow'] = colors['accent'] + '4d';
  
  const id = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
  
  try {
    const res = await fetch('/api/themes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, name, author: document.getElementById('theme-author').value || 'User', colors })
    });
    
    if (res.ok) {
      toast('Theme saved!', 'success');
      closeThemeCreator();
      await loadThemes();
      selectTheme(id);
    } else {
      toast('Failed to save theme', 'error');
    }
  } catch (e) {
    toast('Error saving theme', 'error');
  }
}

// ── Log Controls ─────────────────────────────────────────────────────────────
function copyLogs(id, btn) {
  const el = document.getElementById(`logs-${id}`);
  if (!el) return;
  
  const text = Array.from(el.querySelectorAll('.log-line')).map(l => l.textContent).join('\n');
  navigator.clipboard.writeText(text).then(() => {
    btn.classList.add('copied');
    btn.textContent = '✓ Copied!';
    setTimeout(() => { btn.classList.remove('copied'); btn.textContent = '📋 Copy'; }, 1500);
  });
}

function toggleAutoScroll(id, btn) {
  const el = document.getElementById(`logs-${id}`);
  if (!el) return;
  
  const enabled = el.dataset.autoscroll !== 'false';
  el.dataset.autoscroll = !enabled;
  btn.classList.toggle('active', !enabled);
  btn.textContent = !enabled ? '↓ Auto-scroll' : '○ Auto-scroll';
}

// ── Keyboard Shortcuts ───────────────────────────────────────────────────────
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeModal();
    closeFolderModal();
    closeSettingsModal();
    closeThemeCreator();
    document.getElementById('settings-modal').classList.remove('open');
  }
  if (e.key === 'Enter' && !e.ctrlKey && !e.metaKey) {
    if (document.getElementById('modal').classList.contains('open')) saveService();
    if (document.getElementById('folder-modal').classList.contains('open')) saveFolder();
    if (document.getElementById('theme-creator-modal').classList.contains('open')) saveCustomTheme();
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    document.getElementById('search').focus();
  }
  if (e.shiftKey && e.key === 'N') {
    e.preventDefault();
    openModal();
  }
  if (e.shiftKey && e.key === 'F') {
    e.preventDefault();
    openFolderModal();
  }
  if (e.key === '?' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
    openSettingsModal();
  }
});

// ── Connection Status ────────────────────────────────────────────────────────
function updateConnectionStatus(connected) {
  const el = document.getElementById('connection-status');
  if (!el) return;
  el.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
  el.querySelector('.label').textContent = connected ? 'Connected' : 'Disconnected';
}

socket.on('connect', () => {
  updateConnectionStatus(true);
  loadServices();
});
socket.on('disconnect', () => updateConnectionStatus(false));
socket.on('connect_error', () => updateConnectionStatus(false));

// ── Folder Actions ────────────────────────────────────────────────────────────
async function folderAction(folderId, action) {
  const folderServices = services.filter(s => s.folderId === folderId);
  if (!folderServices.length) { toast('Folder is empty'); return; }
  
  const actions = {
    start: folderServices.filter(s => s.status === 'stopped'),
    stop: folderServices.filter(s => s.status === 'running'),
    restart: folderServices.filter(s => s.status === 'running')
  };
  
  const targets = actions[action] || [];
  for (const s of targets) await ctrl(s.id, action);
  toast(`${action} ${targets.length} service(s)`, 'success');
}

// ── Initialize ───────────────────────────────────────────────────────────────
async function initializeApp() {
  try {
    // Load themes first
    await loadThemes();
    
    // Apply saved theme if it exists
    if (settings.theme) {
      currentTheme = settings.theme;
      const theme = themes.find(t => t.id === settings.theme);
      if (theme) {
        applyTheme(theme.colors);
      } else {
        console.warn(`Theme '${settings.theme}' not found, using default`);
        // Fallback to first available theme or dark-default
        const fallbackTheme = themes.find(t => t.id === 'dark-default') || themes[0];
        if (fallbackTheme) {
          currentTheme = fallbackTheme.id;
          applyTheme(fallbackTheme.colors);
          // Update settings to use the fallback theme
          settings.theme = fallbackTheme.id;
          await fetch('/api/settings', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
          });
        }
      }
    }
  } catch (error) {
    console.error('Failed to initialize app:', error);
    // Apply default theme as fallback
    const defaultTheme = themes.find(t => t.id === 'dark-default') || themes[0];
    if (defaultTheme) {
      currentTheme = defaultTheme.id;
      applyTheme(defaultTheme.colors);
    }
  }
}

// Initialize the app
initializeApp();
</script>
</body>
</html>
